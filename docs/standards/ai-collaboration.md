# AI 协作规范 (AI Collaboration Standards)

本规范为墨梅 (Momei) 项目中 AI 智能体（Agents）的行为准则，旨在确保 AI 在自动化过程中逻辑严密、安全合规且不破坏现有工程质量。

## 1. 身份认同 (Identity)

每个 AI 智能体在启动任务前，必须明确自己的角色定位（见 `AGENTS.md`）。
- **禁止跨权**：`@qa-assistant` 严禁修改代码；`@test-engineer` 应专注于测试编写。
- **环境感知**：执行命令前，必须通过 `os` 信息判断当前是 Windows 还是 POSIX 环境，并使用正确的命令语法。

## 2. 核心工作流：PDTFC+ 2.0 循环

所有写操作任务必须遵循以下确定的执行顺序。**严禁跨越关键质量阈值。**

### P (Plan) - 需求分析与规划
- **意图抽离**：必须读取 `docs/plan/todo.md`，若存在歧义必须发起“采访”模式。
- **任务定义**：更新 `todo.md`，将任务标记为 `in-progress`。
- **方案设计**：输出受影响文件清单及技术实现路径。

### D (Do) - 业务执行
- **数据库优先**：若涉及持久化，必须优先开发数据库实体/Schema。
- **实现准则**：遵循 TypeScript 架构，禁止使用 `any`，UI 文本必须 i18n 化。
- **自检**：开发完成必须通过 `pnpm lint` 和 `pnpm typecheck`。

### A (Audit) - 代码审计
- **安全扫描**：检查 XSS、SQL 注入、鉴权逻辑和密钥泄露。
- **一致性检查**：确保代码实现与 P 阶段设计的方案和 todo 描述一致。

### C (Commit 1) - 功能提交
- **原子化提交**：仅提交业务逻辑改动，使用 `conventional-committer` 生成规范消息。

### V (Validate) - UI 验证
- **视觉审计**：对 UI 改动进行浏览器验证。若自动化工具失效，应向用户展示截图或请求人工验证。

### T (Test) - 质量检查
- **测试覆盖**：编写 Vitest 测试用例。测试代码本身也必须经过 A 阶段的 Lint 和类型检查。

### C+ (Commit 2) - 测试提交
- **完整交付**：提交增强后的测试代码。

### F (Finish) - 任务完结
- **闭环管理**：更新 `todo.md` 状态为 `completed`，并及时补充项目相关的技术文档。

## 3. 安全与红线 (Security Redlines)

1.  **敏感文件保护**：严禁修改或删除 `.env`, `AGENTS.md` 等核心配置文件，除非有明确指示。
2.  **路径校验**：执行涉及删除的命令 (`rm`, `rd`) 前，必须验证路径是否存在且非空。
3.  **密钥脱敏**：绝不在代码或日志中硬编码 API Key、Token 或任何敏感凭据。
4.  **死循环规避**：如果在 F 阶段重复 3 次仍无法修复 Bug，必须停止执行并请求人类介入，禁止无限循环。

## 4. 沟通原则

- **简明扼要**：回复应直接、专业，避免冗余的客套话。
- **证据链条**：在提出方案或得出结论时，应引用具体的代码文件路径或文档内容。
- **透明度**：在执行大规模修改前，应向用户展示预期的代码变更范围。
