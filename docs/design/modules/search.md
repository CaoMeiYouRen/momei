# 搜索模块设计文档 (Search Module Design)

## 1. 概述 (Overview)

搜索功能是博客系统的核心导航手段之一。其目标是让用户能够在海量文章中精准找到关注的内容。高级搜索需要支持全文检索、多维度过滤（分类、标签、语言）以及相关性排序。

## 2. 核心挑战与策略 (Core Challenges & Strategies)

### 2.1 国际化 (i18n) 检索

-   **挑战**: 在墨梅的设计中，不同语言版本是独立的 Post 实体。
-   **策略**:
    -   **自动过滤**: 默认搜索结果仅显示与当前站点语言一致的内容。
    -   **跨语言搜索**: 提供开关允许用户搜索“所有语言”的结果。
    -   **结果去重**: 如果搜索结果中有同一个翻译簇（相同 `translationId`）的多篇文章，根据权重（当前语言优先）仅展示最佳匹配项。

### 2.2 过滤维度

-   **分类 (Category)**: 单选过滤。
-   **标签 (Tag)**: 多选过滤。
-   **作者 (Author)**: 虽然目前暂不需要，但架构应预留支持。

## 3. 技术选型 (Technical Selection)

-   **当前方案 (Current)**: 基于数据库的 `LIKE` 优化查询。
    -   **性能保障**: 通过为 `title`, `status`, `language`, `publishedAt`, `translationId` 等关键字段建立索引，结合 `status='published'` 和 `language` 的预过滤，极大地缩小了全文扫描的范围。
    -   **范围控制**: 默认搜索 `title` 和 `summary`。只有当关键词长度超过一定阈值（如 3 个字符）时才搜索 `content`。
    -   **频率限制**: API 层级实现了针对 `/api/search` 的频率限制（20 次/分钟），防止恶意扫描和数据库过载。
-   **进阶方案 (P1 - 待定)**: 集成 **Algolia** / **Meilisearch**。
    -   由于当前系统流量和数据规模预估，数据库优化方案已足够满足需求，故第三方集成计划延后。

## 4. 接口设计 (API Design)

### 4.1 综合搜索接口

`GET /api/search`

-   **请求参数**:

    -   `q`: 搜索关键词 (可选)。
    -   `language`: 指定语言编码 (可选，如 `zh-CN`, `en-US`)。
    -   `category`: 分类 ID 或 Slug (可选)。
    -   `tags`: 标签 ID 或 Slug 列表 (可选)。
    -   `sortBy`: 排序字段 (`relevance`, `publishedAt`, `views`，默认 `relevance`)。
    -   `page`: 分页码 (默认 1)。
    -   `limit`: 每页数量 (默认 10)。

-   **约束**:

    -   `q` 长度至少为 1 个字符。
    -   对 `/api/search` 接口有较严格的 Rate Limit (20 req/min)。

-   **性能说明**:

    -   后端在执行关键字匹配前，会先利用索引过滤 `status` (仅已发布) 和 `language`。
    -   对于 `content` 的搜索仅在关键词长度大于 3 时触发，以降低计算开销。

-   **响应格式**:

```json
{
    "code": 200,
    "data": {
        "list": [
            {
                "id": "...",
                "title": "...",
                "slug": "...",
                "summary": "...",
                "language": "zh-CN",
                "category": { "name": "..." },
                "tags": [{ "name": "..." }],
                "highlights": { "title": "...", "content": "..." }
            }
        ],
        "total": 50,
        "page": 1,
        "limit": 10
    }
}
```

## 5. UI/UX 设计原则

1. **全局快捷键**: 支持 `Ctrl+K` (或 `Cmd+K`) 唤起搜索弹窗。
2. **实时反馈**: 搜索框输入时显示建议列表。
3. **标签过滤 UI**: 在搜索结果页侧边栏提供分类点击过滤和标签云。
4. **高亮显示**: 在搜索结果的标题和摘要中高亮显示命中的关键词。

## 6. 待办事项 (Todos)

-   [ ] 实现 `GET /api/search` 基础 API。
-   [ ] 后端支持多级 SQL 关联查询以支持按标签和分类过滤。
-   [ ] 前端实现全局搜索组件 (Modal)。
-   [ ] 搜索结果页开发，包含侧边栏过滤功能。
